{% extends 'base.html' %}

{% block title %}{{ t('app_name') }}{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% else %}
    <!-- Section du meilleur réseau -->
    <div class="card mb-4">
        <div class="card-header bg-primary bg-gradient">
            <h2 class="h5 mb-0">
                <i class="fas fa-star me-2"></i> {{ t('best_network') }}
            </h2>
        </div>
        <div class="card-body">
            {% if network %}
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h3 class="h4">{{ network.ssid }}</h3>
                    <div class="mt-2">
                        <span class="badge bg-info">{{ network.security }}</span>
                        <span class="badge bg-secondary">{{ network.frequency }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-signal fa-2x text-info"></i>
                        </div>
                        <div>
                            <small class="text-muted">{{ t('signal') }}</small>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-info" role="progressbar" 
                                    style="width: {{ ((network.rssi + 100) / 100) * 100 }}%"></div>
                            </div>
                            <small>{{ network.rssi }} dBm</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary btn-sm me-2" onclick="analyzeNetwork(0)">
                        <i class="fas fa-shield-alt me-1"></i> {{ t('analyze_security') }}
                    </button>
                    <a href="{{ url_for('assistant_page') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-robot me-1"></i> {{ t('consult_assistant') }}
                    </a>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i> {{ t('no_networks') }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Technologies réseau détectées -->
    <div class="card mb-4">
        <div class="card-header bg-secondary bg-gradient">
            <h2 class="h5 mb-0">
                <i class="fas fa-broadcast-tower me-2"></i> Technologies Réseau
            </h2>
        </div>
        <div class="card-body">
            <div class="row">
                {% if network_status %}
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="technology-icon {% if network_status.wifi %}active{% endif %} me-3">
                                <i class="fas fa-wifi"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">WiFi</h5>
                                <span class="text-{% if network_status.wifi %}success{% else %}danger{% endif %}">
                                    {% if network_status.wifi %}Actif{% else %}Inactif{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="technology-icon {% if network_status.bluetooth %}active{% endif %} me-3">
                                <i class="fab fa-bluetooth-b"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Bluetooth</h5>
                                <span class="text-{% if network_status.bluetooth %}success{% else %}danger{% endif %}">
                                    {% if network_status.bluetooth %}Actif{% else %}Inactif{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="technology-icon {% if network_status.lte %}active{% endif %} me-3">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">LTE</h5>
                                <span class="text-{% if network_status.lte %}success{% else %}danger{% endif %}">
                                    {% if network_status.lte %}Actif{% else %}Inactif{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="technology-icon {% if network_status.esim %}active{% endif %} me-3">
                                <i class="fas fa-sim-card"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">eSIM</h5>
                                <span class="text-{% if network_status.esim %}success{% else %}danger{% endif %}">
                                    {% if network_status.esim %}Actif{% else %}Inactif{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i> Statut des technologies réseau non disponible
                        </div>
                    </div>
                {% endif %}
            </div>
            <button id="refresh-network-btn" class="btn btn-sm btn-outline-secondary mt-3">
                <i class="fas fa-sync-alt me-1"></i> Rafraîchir le statut
            </button>
        </div>
    </div>

    <!-- Liste des réseaux détectés -->
    <div class="card">
        <div class="card-header bg-dark">
            <h2 class="h5 mb-0">
                <i class="fas fa-list me-2"></i> {{ t('all_networks') }}
            </h2>
        </div>
        <div class="card-body p-0">
            {% if all_networks %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>{{ t('ssid') }}</th>
                            <th>{{ t('signal_strength') }}</th>
                            <th>{{ t('frequency') }}</th>
                            <th>{{ t('security') }}</th>
                            <th class="text-end">{{ t('actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for net in all_networks %}
                        <tr>
                            <td>{{ net.ssid }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2" style="width: 100px; height: 8px;">
                                        <div class="progress-bar bg-info" role="progressbar" 
                                            style="width: {{ ((net.rssi + 100) / 100) * 100 }}%"></div>
                                    </div>
                                    <small>{{ net.rssi }} dBm</small>
                                </div>
                            </td>
                            <td>{{ net.frequency }}</td>
                            <td>
                                <span class="badge bg-{% if 'WPA3' in net.security %}success{% elif 'WPA2' in net.security %}info{% elif 'WPA' in net.security %}warning{% else %}danger{% endif %}">
                                    {{ net.security or t('security_unknown') }}
                                </span>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-primary btn-sm" onclick="analyzeNetwork({{loop.index}})">
                                    <i class="fas fa-shield-alt me-1"></i> {{ t('analyze_security') }}
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="card-footer small text-muted">
                <i class="fas fa-info-circle me-1"></i> {{ t('auto_update') }}
            </div>
            {% else %}
            <div class="alert alert-info m-3">
                <i class="fas fa-info-circle me-2"></i> {{ t('no_networks') }}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal pour l'analyse de sécurité -->
<div class="modal fade" id="securityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Analyse de sécurité</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="security-result">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2">Analyse en cours...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Connexion WebSocket
    const socket = io();
    
    // Écouteurs pour les mises à jour
    socket.on('network_update', function(data) {
        // Mettre à jour la page avec les nouvelles données
        console.log('Mise à jour des réseaux reçue');
        location.reload();
    });
    
    socket.on('technology_status_update', function(data) {
        console.log('Mise à jour du statut des technologies reçue', data);
        location.reload();
    });
    
    socket.on('security_analysis_result', function(result) {
        displaySecurityResult(result);
    });
    
    // Demander une mise à jour des réseaux toutes les 10 secondes
    setInterval(function() {
        socket.emit('request_network_update');
    }, 10000);
    
    // Bouton de rafraîchissement du statut
    document.getElementById('refresh-network-btn').addEventListener('click', function() {
        socket.emit('request_technology_status');
    });
    
    // Fonction pour analyser un réseau
    function analyzeNetwork(networkId) {
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('securityModal'));
        modal.show();
        
        // Initialiser le contenu
        document.getElementById('security-result').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Analyse en cours...</p>
            </div>
        `;
        
        // Envoyer la demande d'analyse via WebSocket
        socket.emit('analyze_network_security', { network_id: networkId });
    }
    
    // Afficher les résultats de l'analyse
    function displaySecurityResult(result) {
        if (result.error) {
            document.getElementById('security-result').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i> ${result.error}
                </div>
            `;
            return;
        }
        
        const securityLevelColors = {
            'TRÈS ÉLEVÉ': 'success',
            'ÉLEVÉ': 'success',
            'MOYEN': 'warning',
            'FAIBLE': 'danger',
            'TRÈS FAIBLE': 'danger'
        };
        
        const securityColor = securityLevelColors[result.security_level] || 'secondary';
        
        let html = `
            <div class="text-center mb-4">
                <div class="display-4 fw-bold text-${securityColor}">
                    ${result.total_score}%
                </div>
                <div class="fs-5 text-${securityColor} mt-2">
                    ${result.security_level}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <h5>Chiffrement</h5>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-${result.details.encryption.percentage >= 70 ? 'success' : (result.details.encryption.percentage >= 40 ? 'warning' : 'danger')}" 
                             style="width: ${result.details.encryption.percentage}%"></div>
                    </div>
                    <small class="text-muted">${result.details.encryption.type}</small>
                </div>
                
                <div class="col-md-4">
                    <h5>Signal</h5>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-${result.details.signal_strength.percentage >= 70 ? 'success' : (result.details.signal_strength.percentage >= 40 ? 'warning' : 'danger')}" 
                             style="width: ${result.details.signal_strength.percentage}%"></div>
                    </div>
                    <small class="text-muted">${result.details.signal_strength.level}</small>
                </div>
                
                <div class="col-md-4">
                    <h5>Fréquence</h5>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-${result.details.frequency.percentage >= 70 ? 'success' : (result.details.frequency.percentage >= 40 ? 'warning' : 'danger')}" 
                             style="width: ${result.details.frequency.percentage}%"></div>
                    </div>
                    <small class="text-muted">${result.details.frequency.band}</small>
                </div>
            </div>
            
            <h5 class="mt-4 mb-3">Recommandations</h5>
            <ul class="list-group">`;
        
        for (const rec of result.overall_recommendation) {
            html += `
                <li class="list-group-item">
                    <i class="fas fa-check-circle text-info me-2"></i> ${rec}
                </li>`;
        }
        
        html += `
            </ul>
            
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <a href="${window.location.origin}/assistant" class="btn btn-primary">
                    <i class="fas fa-robot me-1"></i> Consulter l'assistant
                </a>
            </div>
        `;
        
        document.getElementById('security-result').innerHTML = html;
    }
</script>
{% endblock %}