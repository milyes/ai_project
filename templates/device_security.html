<!DOCTYPE html>
<html lang="{{ current_language }}" data-bs-theme="dark" dir="{{ text_direction }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t('nav_device_security') }} - {{ t('app_name') }}</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container py-5">
        <nav class="navbar navbar-expand-lg navbar-dark mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="{{ url_for('accueil') }}">
                    <i class="fas fa-wifi me-2"></i> {{ t('app_name') }}
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('accueil') }}">{{ t('nav_home') }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('security_report') }}">{{ t('nav_security_report') }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('assistant_page') }}">{{ t('nav_assistant') }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('personalized_recommendations') }}">{{ t('nav_recommendations') }}</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{{ url_for('device_security') }}">{{ t('nav_device_security') }}</a>
                        </li>
                    </ul>
                    <!-- Language selector -->
                    <div class="dropdown">
                        <button class="btn btn-dark dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-globe me-2"></i> {{ t('nav_language') }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
                            {% for code, name in available_languages.items() %}
                            <li>
                                <a class="dropdown-item {% if current_language == code %}active{% endif %}" href="{{ url_for('set_language', language=code) }}">
                                    {{ name }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- En-tête de la page -->
        <div class="row mb-4">
            <div class="col-lg-8 mx-auto">
                <div class="d-flex align-items-center mb-4">
                    <div>
                        <h1 class="display-5 mb-0">{{ t('device_security_title') }}</h1>
                        <p class="text-muted">{{ t('device_security_subtitle') }}</p>
                    </div>
                    <div class="ms-auto">
                        <button id="refreshBtn" class="btn btn-primary">
                            <i class="fas fa-sync-alt me-1"></i> {{ t('refresh') }}
                        </button>
                    </div>
                </div>

                <!-- Récapitulatif de la sécurité réseau -->
                <div class="card bg-dark mb-4">
                    <div class="card-header bg-primary bg-opacity-25">
                        <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i> {{ t('network_security_overview') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-7">
                                <div class="d-flex align-items-end mb-3">
                                    <div>
                                        <h6 class="text-muted mb-1">{{ t('global_security_score') }}</h6>
                                        <h1 class="display-4 mb-0 security-score" id="globalSecurityScore">-</h1>
                                    </div>
                                    <div class="ms-auto">
                                        <span class="badge p-2" id="scoreUpdateTime">{{ t('last_updated') }}: -</span>
                                    </div>
                                </div>
                                
                                <div class="bg-dark rounded p-3 mb-3">
                                    <div class="row g-2">
                                        <div class="col-4">
                                            <div class="text-center">
                                                <div class="text-danger mb-1 fs-4" id="criticalDevices">-</div>
                                                <div class="small text-muted">{{ t('critical_devices') }}</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-center">
                                                <div class="text-warning mb-1 fs-4" id="warningDevices">-</div>
                                                <div class="small text-muted">{{ t('warning_devices') }}</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-center">
                                                <div class="text-success mb-1 fs-4" id="secureDevices">-</div>
                                                <div class="small text-muted">{{ t('secure_devices') }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i> {{ t('security_refresh_message') }}
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="chart-container" style="position: relative; height:200px;">
                                    <canvas id="securityDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Liste des appareils -->
                <div class="card bg-dark mb-4">
                    <div class="card-header bg-success bg-opacity-25 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-laptop me-2"></i> {{ t('connected_devices') }}</h5>
                        <div>
                            <span class="badge bg-secondary" id="deviceCount">{{ t('devices_found', count=0) }}</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="devicesList" class="list-group list-group-flush">
                            <div class="list-group-item bg-dark text-center p-4" id="noDevicesMessage">
                                <i class="fas fa-search fa-2x mb-3 text-muted"></i>
                                <h5>{{ t('no_devices_found') }}</h5>
                                <p class="text-muted mb-0">{{ t('no_devices_message') }}</p>
                            </div>
                            <!-- Les appareils seront injectés ici dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Explications de la notation -->
                <div class="card bg-info bg-opacity-10">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-question-circle me-2"></i> {{ t('how_scoring_works') }}</h5>
                        <p>{{ t('scoring_explanation') }}</p>
                        <div class="row mb-3">
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="card bg-danger bg-opacity-25 h-100">
                                    <div class="card-body">
                                        <h6>{{ t('critical_score') }} (0-49)</h6>
                                        <p class="small mb-0">{{ t('critical_score_description') }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="card bg-warning bg-opacity-25 h-100">
                                    <div class="card-body">
                                        <h6>{{ t('warning_score') }} (50-69)</h6>
                                        <p class="small mb-0">{{ t('warning_score_description') }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success bg-opacity-25 h-100">
                                    <div class="card-body">
                                        <h6>{{ t('secure_score') }} (70-100)</h6>
                                        <p class="small mb-0">{{ t('secure_score_description') }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="mb-0 fst-italic">{{ t('security_scoring_privacy') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour les détails de l'appareil -->
    <div class="modal fade" id="deviceDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceName">{{ t('device_details') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>{{ t('device_info') }}</h6>
                            <table class="table table-dark table-sm">
                                <tr>
                                    <th>MAC:</th>
                                    <td id="deviceMAC"></td>
                                </tr>
                                <tr>
                                    <th>IP:</th>
                                    <td id="deviceIP"></td>
                                </tr>
                                <tr>
                                    <th>{{ t('type') }}:</th>
                                    <td id="deviceType"></td>
                                </tr>
                                <tr>
                                    <th>{{ t('manufacturer') }}:</th>
                                    <td id="deviceManufacturer"></td>
                                </tr>
                                <tr>
                                    <th>OS:</th>
                                    <td id="deviceOS"></td>
                                </tr>
                                <tr>
                                    <th>{{ t('first_seen') }}:</th>
                                    <td id="deviceFirstSeen"></td>
                                </tr>
                                <tr>
                                    <th>{{ t('last_seen') }}:</th>
                                    <td id="deviceLastSeen"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center mb-3">
                                <h6>{{ t('security_score') }}</h6>
                                <div class="display-1" id="modalDeviceScore">-</div>
                                <div class="badge" id="scoreCategory">{{ t('critical_score') }}</div>
                            </div>
                            <div class="chart-container" style="position: relative; height:150px;">
                                <canvas id="deviceScoreHistory"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <h6>{{ t('security_issues') }}</h6>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>{{ t('issue') }}</th>
                                    <th>{{ t('status') }}</th>
                                    <th>{{ t('impact') }}</th>
                                </tr>
                            </thead>
                            <tbody id="securityIssuesTable">
                                <!-- Les problèmes de sécurité seront injectés ici -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-warning" id="deviceRecommendations">
                        <h6 class="alert-heading">{{ t('security_recommendations') }}</h6>
                        <ul class="mb-0" id="recommendationsList">
                            <!-- Les recommandations seront injectées ici -->
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('close') }}</button>
                    <button type="button" class="btn btn-primary" id="checkDeviceBtn">{{ t('recheck_device') }}</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialiser Socket.IO
        const socket = io();
        let securityDistributionChart;
        let deviceScoreHistoryChart;
        let currentDevices = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Demander les données initiales
            refreshDeviceData();
            
            // Configuration du graphique de distribution de sécurité
            const ctx = document.getElementById('securityDistributionChart').getContext('2d');
            securityDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [
                        "{{ t('critical_devices') }}", 
                        "{{ t('warning_devices') }}", 
                        "{{ t('secure_devices') }}"
                    ],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#dc3545', '#ffc107', '#198754'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#adb5bd'
                            }
                        }
                    }
                }
            });
            
            // Configurer le bouton de rafraîchissement
            document.getElementById('refreshBtn').addEventListener('click', function() {
                refreshDeviceData();
            });
            
            // Configurer le bouton de revérification de l'appareil
            document.getElementById('checkDeviceBtn').addEventListener('click', function() {
                const deviceMAC = document.getElementById('deviceMAC').textContent;
                socket.emit('check_device_security', { mac_address: deviceMAC });
                
                // Fermer le modal après l'émission de l'événement
                const modal = bootstrap.Modal.getInstance(document.getElementById('deviceDetailModal'));
                modal.hide();
                
                // Rafraîchir les données après un court délai
                setTimeout(refreshDeviceData, 1000);
            });
        });
        
        // Fonction pour rafraîchir les données des appareils
        function refreshDeviceData() {
            socket.emit('request_device_security_update');
        }
        
        // Écouter les mises à jour de sécurité des appareils
        socket.on('device_security_update', function(data) {
            currentDevices = data.devices;
            updateDeviceList(data.devices);
            updateSecurityOverview(data.network_status);
        });
        
        // Mettre à jour la liste des appareils
        function updateDeviceList(devices) {
            const devicesList = document.getElementById('devicesList');
            const noDevicesMessage = document.getElementById('noDevicesMessage');
            const deviceCount = document.getElementById('deviceCount');
            
            // Mettre à jour le compteur d'appareils
            deviceCount.textContent = "{{ t('devices_found', count='') }}" + devices.length;
            
            // Afficher ou masquer le message "Aucun appareil"
            if (devices.length === 0) {
                noDevicesMessage.style.display = 'block';
                devicesList.innerHTML = '';
                devicesList.appendChild(noDevicesMessage);
                return;
            } else {
                noDevicesMessage.style.display = 'none';
            }
            
            // Vider la liste actuelle mais conserver le message
            const currentHTML = devicesList.innerHTML;
            devicesList.innerHTML = '';
            devicesList.appendChild(noDevicesMessage);
            
            // Ajouter chaque appareil à la liste
            devices.forEach((device, index) => {
                const deviceItem = document.createElement('div');
                deviceItem.className = 'list-group-item bg-dark border-secondary';
                
                // Déterminer la classe de couleur en fonction du score
                let scoreColorClass = 'text-danger';
                if (device.security_score >= 70) {
                    scoreColorClass = 'text-success';
                } else if (device.security_score >= 50) {
                    scoreColorClass = 'text-warning';
                }
                
                deviceItem.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-1">${device.device_name}</h5>
                            <div class="d-flex text-muted small mb-2">
                                <div class="me-3"><i class="fas fa-network-wired me-1"></i> ${device.ip_address}</div>
                                <div><i class="fas fa-tag me-1"></i> ${device.device_type}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1" style="height: 8px;">
                                    <div class="progress-bar bg-${scoreColorClass.replace('text-', '')}" 
                                         role="progressbar" 
                                         style="width: ${device.security_score}%"></div>
                                </div>
                                <div class="ms-3 ${scoreColorClass} fw-bold">${device.security_score}</div>
                            </div>
                            <div class="small text-muted mt-1">
                                <i class="fas fa-shield-alt me-1"></i> ${getScoreCategory(device.security_score)}
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-outline-info view-device" 
                                    data-index="${index}" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deviceDetailModal">
                                <i class="fas fa-info-circle me-1"></i> {{ t('details') }}
                            </button>
                        </div>
                    </div>
                `;
                
                devicesList.appendChild(deviceItem);
                
                // Ajouter l'écouteur d'événements pour le bouton de détails
                const viewBtn = deviceItem.querySelector('.view-device');
                viewBtn.addEventListener('click', function() {
                    const deviceIndex = this.getAttribute('data-index');
                    showDeviceDetails(devices[deviceIndex]);
                });
            });
        }
        
        // Mettre à jour la vue d'ensemble de la sécurité
        function updateSecurityOverview(status) {
            // Mettre à jour le score global
            const globalScoreElement = document.getElementById('globalSecurityScore');
            globalScoreElement.textContent = status.score_global;
            
            // Définir la couleur du score
            globalScoreElement.className = 'display-4 mb-0 security-score';
            if (status.score_global >= 70) {
                globalScoreElement.classList.add('text-success');
            } else if (status.score_global >= 50) {
                globalScoreElement.classList.add('text-warning');
            } else {
                globalScoreElement.classList.add('text-danger');
            }
            
            // Mettre à jour les compteurs d'appareils
            document.getElementById('criticalDevices').textContent = status.appareils_critiques;
            document.getElementById('warningDevices').textContent = status.appareils_attention;
            document.getElementById('secureDevices').textContent = status.appareils_securises;
            
            // Mettre à jour l'heure de mise à jour
            const updateTime = new Date(status.derniere_mise_a_jour);
            document.getElementById('scoreUpdateTime').textContent = "{{ t('last_updated') }}: " + 
                updateTime.toLocaleTimeString();
            
            // Mettre à jour le graphique de distribution
            securityDistributionChart.data.datasets[0].data = [
                status.appareils_critiques,
                status.appareils_attention,
                status.appareils_securises
            ];
            securityDistributionChart.update();
        }
        
        // Afficher les détails d'un appareil
        function showDeviceDetails(device) {
            // Informations générales de l'appareil
            document.getElementById('deviceName').textContent = device.device_name;
            document.getElementById('deviceMAC').textContent = device.mac_address;
            document.getElementById('deviceIP').textContent = device.ip_address;
            document.getElementById('deviceType').textContent = device.device_type;
            document.getElementById('deviceManufacturer').textContent = device.manufacturer;
            document.getElementById('deviceOS').textContent = device.os_type;
            
            // Dates de première et dernière visualisation
            const firstSeen = new Date(device.first_seen);
            const lastSeen = new Date(device.last_seen);
            document.getElementById('deviceFirstSeen').textContent = firstSeen.toLocaleString();
            document.getElementById('deviceLastSeen').textContent = lastSeen.toLocaleString();
            
            // Score de sécurité
            const modalScore = document.getElementById('modalDeviceScore');
            modalScore.textContent = device.security_score;
            
            // Définir la couleur et la catégorie du score
            modalScore.className = 'display-1';
            const scoreCategory = document.getElementById('scoreCategory');
            
            if (device.security_score >= 70) {
                modalScore.classList.add('text-success');
                scoreCategory.textContent = "{{ t('secure_score') }}";
                scoreCategory.className = 'badge bg-success';
            } else if (device.security_score >= 50) {
                modalScore.classList.add('text-warning');
                scoreCategory.textContent = "{{ t('warning_score') }}";
                scoreCategory.className = 'badge bg-warning text-dark';
            } else {
                modalScore.classList.add('text-danger');
                scoreCategory.textContent = "{{ t('critical_score') }}";
                scoreCategory.className = 'badge bg-danger';
            }
            
            // Historique des scores
            updateDeviceScoreHistory(device.score_history);
            
            // Problèmes de sécurité
            updateSecurityIssuesTable(device.security_details);
            
            // Recommandations
            updateRecommendations(device);
        }
        
        // Mettre à jour le graphique d'historique des scores
        function updateDeviceScoreHistory(history) {
            const ctx = document.getElementById('deviceScoreHistory').getContext('2d');
            
            // Détruire le graphique précédent s'il existe
            if (deviceScoreHistoryChart) {
                deviceScoreHistoryChart.destroy();
            }
            
            // Préparer les données pour le graphique
            const data = [];
            const labels = [];
            
            // Limiter à 10 entrées les plus récentes
            const recentHistory = history.slice(-10);
            
            recentHistory.forEach(entry => {
                data.push(entry.score);
                const date = new Date(entry.timestamp);
                labels.push(date.toLocaleTimeString());
            });
            
            // Créer le nouveau graphique
            deviceScoreHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "{{ t('security_score') }}",
                        data: data,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            ticks: {
                                color: '#adb5bd'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#adb5bd'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Mettre à jour le tableau des problèmes de sécurité
        function updateSecurityIssuesTable(securityDetails) {
            const issuesTable = document.getElementById('securityIssuesTable');
            issuesTable.innerHTML = '';
            
            // Créer une ligne pour chaque problème de sécurité
            const issues = [
                {
                    name: "{{ t('firmware_version') }}",
                    value: securityDetails.firmware_version,
                    status: getStatusFromFirmware(securityDetails.firmware_version),
                    impact: getImpactFromFirmware(securityDetails.firmware_version)
                },
                {
                    name: "{{ t('update_status') }}",
                    value: securityDetails.update_status,
                    status: getStatusFromUpdate(securityDetails.update_status),
                    impact: getImpactFromUpdate(securityDetails.update_status)
                },
                {
                    name: "{{ t('vulnerabilities') }}",
                    value: securityDetails.known_vulnerabilities,
                    status: getStatusFromVulnerability(securityDetails.known_vulnerabilities),
                    impact: getImpactFromVulnerability(securityDetails.known_vulnerabilities)
                },
                {
                    name: "{{ t('open_ports') }}",
                    value: securityDetails.open_ports,
                    status: getStatusFromPorts(securityDetails.open_ports),
                    impact: getImpactFromPorts(securityDetails.open_ports)
                },
                {
                    name: "{{ t('encryption') }}",
                    value: securityDetails.encryption_level,
                    status: getStatusFromEncryption(securityDetails.encryption_level),
                    impact: getImpactFromEncryption(securityDetails.encryption_level)
                },
                {
                    name: "{{ t('password_protection') }}",
                    value: securityDetails.password_protected ? "{{ t('enabled') }}" : "{{ t('disabled') }}",
                    status: securityDetails.password_protected ? 'success' : 'danger',
                    impact: securityDetails.password_protected ? "{{ t('low') }}" : "{{ t('high') }}"
                },
                {
                    name: "{{ t('firewall') }}",
                    value: securityDetails.firewall_enabled ? "{{ t('enabled') }}" : "{{ t('disabled') }}",
                    status: securityDetails.firewall_enabled ? 'success' : 'danger',
                    impact: securityDetails.firewall_enabled ? "{{ t('low') }}" : "{{ t('high') }}"
                },
                {
                    name: "{{ t('suspicious_activity') }}",
                    value: securityDetails.suspicious_activity ? "{{ t('detected') }}" : "{{ t('none') }}",
                    status: securityDetails.suspicious_activity ? 'danger' : 'success',
                    impact: securityDetails.suspicious_activity ? "{{ t('high') }}" : "{{ t('low') }}"
                }
            ];
            
            issues.forEach(issue => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = issue.name;
                
                const statusCell = document.createElement('td');
                statusCell.innerHTML = `<span class="badge bg-${issue.status}">${issue.value}</span>`;
                
                const impactCell = document.createElement('td');
                impactCell.textContent = issue.impact;
                
                row.appendChild(nameCell);
                row.appendChild(statusCell);
                row.appendChild(impactCell);
                
                issuesTable.appendChild(row);
            });
        }
        
        // Mettre à jour les recommandations
        function updateRecommendations(device) {
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';
            
            // Générer des recommandations basées sur les détails de sécurité
            const securityDetails = device.security_details;
            const recommendations = [];
            
            if (securityDetails.firmware_version === "Outdated" || securityDetails.firmware_version === "Very Outdated") {
                recommendations.push("{{ t('rec_update_firmware') }}");
            }
            
            if (securityDetails.update_status === "Updates available" || securityDetails.update_status === "Critical updates needed") {
                recommendations.push("{{ t('rec_install_updates') }}");
            }
            
            if (securityDetails.known_vulnerabilities !== "None detected") {
                recommendations.push("{{ t('rec_address_vulnerabilities') }}");
            }
            
            if (securityDetails.open_ports > 0) {
                recommendations.push("{{ t('rec_close_ports') }}");
            }
            
            if (securityDetails.encryption_level === "Weak" || securityDetails.encryption_level === "None") {
                recommendations.push("{{ t('rec_improve_encryption') }}");
            }
            
            if (!securityDetails.password_protected) {
                recommendations.push("{{ t('rec_enable_password') }}");
            }
            
            if (!securityDetails.firewall_enabled) {
                recommendations.push("{{ t('rec_enable_firewall') }}");
            }
            
            if (securityDetails.suspicious_activity) {
                recommendations.push("{{ t('rec_check_suspicious') }}");
            }
            
            // Si aucune recommandation, ajouter un message par défaut
            if (recommendations.length === 0) {
                recommendations.push("{{ t('rec_device_secure') }}");
            }
            
            // Ajouter les recommandations à la liste
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsList.appendChild(li);
            });
        }
        
        // Fonctions utilitaires pour les statuts et impacts
        function getStatusFromFirmware(firmware) {
            if (firmware === "Latest") return "success";
            if (firmware === "Outdated") return "warning";
            if (firmware === "Very Outdated") return "danger";
            return "secondary";
        }
        
        function getImpactFromFirmware(firmware) {
            if (firmware === "Latest") return "{{ t('low') }}";
            if (firmware === "Outdated") return "{{ t('medium') }}";
            if (firmware === "Very Outdated") return "{{ t('high') }}";
            return "{{ t('unknown') }}";
        }
        
        function getStatusFromUpdate(update) {
            if (update === "Up to date") return "success";
            if (update === "Updates available") return "warning";
            if (update === "Critical updates needed") return "danger";
            return "secondary";
        }
        
        function getImpactFromUpdate(update) {
            if (update === "Up to date") return "{{ t('low') }}";
            if (update === "Updates available") return "{{ t('medium') }}";
            if (update === "Critical updates needed") return "{{ t('high') }}";
            return "{{ t('unknown') }}";
        }
        
        function getStatusFromVulnerability(vulnerability) {
            if (vulnerability === "None detected") return "success";
            if (vulnerability === "Multiple vulnerabilities") return "danger";
            return "warning";
        }
        
        function getImpactFromVulnerability(vulnerability) {
            if (vulnerability === "None detected") return "{{ t('low') }}";
            if (vulnerability === "Multiple vulnerabilities") return "{{ t('high') }}";
            if (vulnerability === "Unpatched CVE" || vulnerability === "Default credentials" || vulnerability === "Weak encryption") {
                return "{{ t('high') }}";
            }
            return "{{ t('medium') }}";
        }
        
        function getStatusFromPorts(ports) {
            if (ports === 0) return "success";
            if (ports >= 3) return "danger";
            return "warning";
        }
        
        function getImpactFromPorts(ports) {
            if (ports === 0) return "{{ t('low') }}";
            if (ports >= 3) return "{{ t('high') }}";
            return "{{ t('medium') }}";
        }
        
        function getStatusFromEncryption(encryption) {
            if (encryption === "Strong") return "success";
            if (encryption === "Medium") return "warning";
            if (encryption === "Weak") return "danger";
            if (encryption === "None") return "danger";
            return "secondary";
        }
        
        function getImpactFromEncryption(encryption) {
            if (encryption === "Strong") return "{{ t('low') }}";
            if (encryption === "Medium") return "{{ t('medium') }}";
            if (encryption === "Weak" || encryption === "None") return "{{ t('high') }}";
            return "{{ t('unknown') }}";
        }
        
        function getScoreCategory(score) {
            if (score >= 70) return "{{ t('secure') }}";
            if (score >= 50) return "{{ t('warning') }}";
            return "{{ t('critical') }}";
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
