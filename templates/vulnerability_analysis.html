{% extends "base.html" %}

{% block title %}Analyse de Vulnérabilités | NetSecure Pro{% endblock %}

{% block extra_css %}
<style>
    .vulnerability-score {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: bold;
        margin: 0 auto 15px auto;
    }
    
    .score-critical {
        background-color: #ff0000;
        color: white;
    }
    
    .score-high {
        background-color: #ff5500;
        color: white;
    }
    
    .score-medium {
        background-color: #ffaa00;
        color: black;
    }
    
    .score-low {
        background-color: #ffdd00;
        color: black;
    }
    
    .score-none {
        background-color: #00dd00;
        color: white;
    }
    
    .timeline {
        position: relative;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .timeline::after {
        content: '';
        position: absolute;
        width: 6px;
        background-color: #dee2e6;
        top: 0;
        bottom: 0;
        left: 50%;
        margin-left: -3px;
    }
    
    .container-timeline {
        padding: 10px 40px;
        position: relative;
        width: 50%;
    }
    
    .container-timeline::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        right: -10px;
        top: 15px;
        border-radius: 50%;
        z-index: 1;
    }
    
    .left {
        left: 0;
    }
    
    .right {
        left: 50%;
    }
    
    .left::before {
        content: " ";
        position: absolute;
        height: 0;
        width: 0;
        top: 22px;
        right: 30px;
        z-index: 1;
        border: medium solid #fff;
        border-width: 10px 0 10px 10px;
        border-color: transparent transparent transparent #fff;
    }
    
    .right::before {
        content: " ";
        position: absolute;
        height: 0;
        width: 0;
        top: 22px;
        left: 30px;
        z-index: 1;
        border: medium solid #fff;
        border-width: 10px 10px 10px 0;
        border-color: transparent #fff transparent transparent;
    }
    
    .right::after {
        left: -10px;
    }
    
    .content {
        padding: 20px 30px;
        background-color: white;
        position: relative;
        border-radius: 6px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .timeline-dot-critical::after {
        background-color: #ff0000;
    }
    
    .timeline-dot-high::after {
        background-color: #ff5500;
    }
    
    .timeline-dot-medium::after {
        background-color: #ffaa00;
    }
    
    .timeline-dot-low::after {
        background-color: #ffdd00;
    }
    
    @media screen and (max-width: 600px) {
        .timeline::after {
            left: 31px;
        }
        
        .container-timeline {
            width: 100%;
            padding-left: 70px;
            padding-right: 25px;
        }
        
        .container-timeline::before {
            left: 60px;
            border: medium solid white;
            border-width: 10px 10px 10px 0;
            border-color: transparent white transparent transparent;
        }
        
        .left::after, .right::after {
            left: 15px;
        }
        
        .right {
            left: 0%;
        }
    }
    
    .cvss-breakdown {
        list-style-type: none;
        padding: 0;
    }
    
    .cvss-breakdown li {
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
    }
    
    .cvss-breakdown .factor {
        font-weight: bold;
    }
    
    .cvss-breakdown .value {
        color: #555;
    }
    
    .badge-critical {
        background-color: #ff0000;
        color: white;
    }
    
    .badge-high {
        background-color: #ff5500;
        color: white;
    }
    
    .badge-medium {
        background-color: #ffaa00;
        color: black;
    }
    
    .badge-low {
        background-color: #ffdd00;
        color: black;
    }
    
    .badge-none {
        background-color: #00dd00;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>Analyse de Vulnérabilités</h1>
        <p class="lead">Identification et évaluation des vulnérabilités de votre réseau.</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                <i class="fas fa-tachometer-alt me-2"></i>Tableau de bord
            </a>
            <button type="button" class="btn btn-primary" id="refreshAnalysisBtn">
                <i class="fas fa-sync-alt me-2"></i>Actualiser l'analyse
            </button>
        </div>
    </div>
</div>

<!-- Résumé des vulnérabilités -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Résumé des vulnérabilités</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center mb-4">
                        <div class="vulnerability-score score-high">7.8</div>
                        <h5>Score CVSS moyen</h5>
                        <p class="text-muted">Niveau de risque: <span class="badge bg-danger">Élevé</span></p>
                    </div>
                    <div class="col-md-9">
                        <div class="row mb-3">
                            <div class="col-md-3 text-center">
                                <h3 class="text-danger">3</h3>
                                <p>Critiques</p>
                            </div>
                            <div class="col-md-3 text-center">
                                <h3 class="text-warning">8</h3>
                                <p>Importantes</p>
                            </div>
                            <div class="col-md-3 text-center">
                                <h3 class="text-info">15</h3>
                                <p>Modérées</p>
                            </div>
                            <div class="col-md-3 text-center">
                                <h3 class="text-success">6</h3>
                                <p>Faibles</p>
                            </div>
                        </div>
                        
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 9.4%;" aria-valuenow="9.4" aria-valuemin="0" aria-valuemax="100">3</div>
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">8</div>
                            <div class="progress-bar bg-info" role="progressbar" style="width: 46.9%;" aria-valuenow="46.9" aria-valuemin="0" aria-valuemax="100">15</div>
                            <div class="progress-bar bg-success" role="progressbar" style="width: 18.7%;" aria-valuenow="18.7" aria-valuemin="0" aria-valuemax="100">6</div>
                        </div>
                        
                        <div class="d-flex justify-content-between small">
                            <span>Dernière analyse: {{ now|datetime }}</span>
                            <span>32 vulnérabilités détectées</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vulnérabilités critiques -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Vulnérabilités critiques (À corriger immédiatement)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>CVE ID</th>
                                <th>Appareil</th>
                                <th>Description</th>
                                <th>Score CVSS</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><a href="https://nvd.nist.gov/vuln/detail/CVE-2022-26928" target="_blank">CVE-2022-26928</a></td>
                                <td>Routeur WiFi Principal</td>
                                <td>Vulnérabilité d'exécution de code à distance dans le firmware</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="badge badge-critical rounded-pill me-2">9.8</span>
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: 98%;" aria-valuenow="98" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#vulnerabilityDetailsModal" data-vuln-id="CVE-2022-26928">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-shield-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-37714" target="_blank">CVE-2021-37714</a></td>
                                <td>Caméra IP</td>
                                <td>Identifiants par défaut exposés permettant un accès non autorisé</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="badge badge-critical rounded-pill me-2">9.6</span>
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: 96%;" aria-valuenow="96" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#vulnerabilityDetailsModal" data-vuln-id="CVE-2021-37714">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-shield-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-12345" target="_blank">CVE-2023-12345</a></td>
                                <td>Smart TV</td>
                                <td>Vulnérabilité de débordement de tampon dans le traitement des paquets réseau</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="badge badge-critical rounded-pill me-2">9.1</span>
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: 91%;" aria-valuenow="91" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#vulnerabilityDetailsModal" data-vuln-id="CVE-2023-12345">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-shield-alt"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historique des vulnérabilités -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historique des vulnérabilités</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="container-timeline left timeline-dot-critical">
                        <div class="content">
                            <h5>CVE-2022-26928 détecté</h5>
                            <p>Vulnérabilité critique (9.8) détectée sur le routeur WiFi Principal</p>
                            <p class="text-muted small">Il y a 2 jours</p>
                        </div>
                    </div>
                    <div class="container-timeline right timeline-dot-medium">
                        <div class="content">
                            <h5>5 nouvelles vulnérabilités moyennes</h5>
                            <p>Détectées sur divers appareils du réseau</p>
                            <p class="text-muted small">Il y a 1 semaine</p>
                        </div>
                    </div>
                    <div class="container-timeline left timeline-dot-high">
                        <div class="content">
                            <h5>CVE-2021-37714 résolu</h5>
                            <p>Le mot de passe par défaut de la caméra IP a été changé</p>
                            <p class="text-muted small">Il y a 2 semaines</p>
                        </div>
                    </div>
                    <div class="container-timeline right timeline-dot-low">
                        <div class="content">
                            <h5>Première analyse de vulnérabilités</h5>
                            <p>23 vulnérabilités détectées sur l'ensemble du réseau</p>
                            <p class="text-muted small">Il y a 1 mois</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les détails de vulnérabilité -->
<div class="modal fade" id="vulnerabilityDetailsModal" tabindex="-1" aria-labelledby="vulnerabilityDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="vulnerabilityDetailsModalLabel">Détails de la vulnérabilité</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <div class="vulnerability-score score-critical">9.8</div>
                        <h4>CVE-2022-26928</h4>
                        <p class="mb-0"><span class="badge badge-critical">Critique</span></p>
                        <p class="small text-muted">Publié le 15/04/2022</p>
                    </div>
                    <div class="col-md-8">
                        <h5>Description</h5>
                        <p>Vulnérabilité d'exécution de code à distance dans le firmware des routeurs Netgear Nighthawk, versions antérieures à 1.0.3.86. Un attaquant non authentifié pourrait exécuter du code arbitraire avec les privilèges du système.</p>
                        
                        <h5 class="mt-4">Vecteurs d'attaque</h5>
                        <p>Attaque réseau à distance ne nécessitant pas d'authentification ni d'interaction de l'utilisateur.</p>
                        
                        <h5 class="mt-4">Appareils affectés</h5>
                        <ul>
                            <li>Routeur WiFi Principal (Netgear Nighthawk RAX50, firmware v1.0.3.80)</li>
                        </ul>
                        
                        <h5 class="mt-4">Détail du score CVSS 3.1</h5>
                        <ul class="cvss-breakdown">
                            <li><span class="factor">Vecteur d'attaque:</span> <span class="value">Réseau</span></li>
                            <li><span class="factor">Complexité d'attaque:</span> <span class="value">Faible</span></li>
                            <li><span class="factor">Privilèges requis:</span> <span class="value">Aucun</span></li>
                            <li><span class="factor">Interaction utilisateur:</span> <span class="value">Aucune</span></li>
                            <li><span class="factor">Portée:</span> <span class="value">Inchangée</span></li>
                            <li><span class="factor">Confidentialité:</span> <span class="value">Élevée</span></li>
                            <li><span class="factor">Intégrité:</span> <span class="value">Élevée</span></li>
                            <li><span class="factor">Disponibilité:</span> <span class="value">Élevée</span></li>
                        </ul>
                    </div>
                </div>
                
                <hr>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h5>Recommandations</h5>
                        <ol>
                            <li>Mettre à jour le firmware du routeur vers la version 1.0.3.86 ou supérieure.</li>
                            <li>En attendant la mise à jour, limiter l'accès au routeur depuis Internet.</li>
                            <li>Activer le pare-feu et désactiver l'administration à distance.</li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h5>Références</h5>
                        <ul>
                            <li><a href="https://nvd.nist.gov/vuln/detail/CVE-2022-26928" target="_blank">Base de données NVD</a></li>
                            <li><a href="https://kb.netgear.com/000064384" target="_blank">Bulletin de sécurité Netgear</a></li>
                            <li><a href="https://www.netgear.com/support/download/" target="_blank">Téléchargement du firmware</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary">Marquer comme résolu</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion du modal des détails de vulnérabilité
        const vulnerabilityModal = document.getElementById('vulnerabilityDetailsModal');
        vulnerabilityModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const vulnId = button.getAttribute('data-vuln-id');
            
            // En fonction de la vulnérabilité, mettre à jour le contenu du modal
            // Dans une version réelle, ces données viendraient d'une API
            if (vulnId === 'CVE-2022-26928') {
                // Le contenu par défaut du modal est déjà pour cette vulnérabilité
            } else if (vulnId === 'CVE-2021-37714') {
                document.querySelector('#vulnerabilityDetailsModal .vulnerability-score').textContent = '9.6';
                document.querySelector('#vulnerabilityDetailsModal h4').textContent = 'CVE-2021-37714';
                document.querySelector('#vulnerabilityDetailsModal .modal-body p:first-of-type').textContent = 
                    'Vulnérabilité critique permettant un accès non autorisé aux caméras IP en raison de l\'utilisation d\'identifiants par défaut. Un attaquant peut accéder à la caméra et visualiser le flux vidéo ou manipuler les paramètres.';
                // Mettre à jour les autres détails...
            } else if (vulnId === 'CVE-2023-12345') {
                document.querySelector('#vulnerabilityDetailsModal .vulnerability-score').textContent = '9.1';
                document.querySelector('#vulnerabilityDetailsModal h4').textContent = 'CVE-2023-12345';
                document.querySelector('#vulnerabilityDetailsModal .modal-body p:first-of-type').textContent = 
                    'Vulnérabilité de débordement de tampon dans le traitement des paquets réseau des Smart TV. Un attaquant peut envoyer des paquets spécialement conçus pour exécuter du code arbitraire sur l\'appareil.';
                // Mettre à jour les autres détails...
            }
        });
        
        // Bouton d'actualisation de l'analyse
        document.getElementById('refreshAnalysisBtn').addEventListener('click', function() {
            // Simuler une actualisation
            const btn = this;
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyse en cours...';
            
            setTimeout(function() {
                btn.disabled = false;
                btn.innerHTML = originalText;
                showNotification('Analyse de vulnérabilités terminée', 'success');
            }, 3000);
        });
    });
</script>
{% endblock %}