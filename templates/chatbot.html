{% extends "layout.html" %}
{% block title %}Assistant Sécurité - Chatbot{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-robot me-2"></i>Assistant Sécurité
                    </h4>
                </div>
                <div class="card-body">
                    <div class="chat-container" id="chatMessages">
                        <div class="chat-welcome mb-4 text-center">
                            <div class="chat-avatar mx-auto mb-3">
                                <i class="fas fa-shield-alt fa-3x text-primary"></i>
                            </div>
                            <h5>Bienvenue sur l'Assistant de Sécurité Réseau</h5>
                            <p class="text-muted">Je suis là pour répondre à vos questions concernant la sécurité de vos réseaux WiFi.</p>
                        </div>
                        <!-- Les messages apparaîtront ici -->
                        <div id="messagesContainer">
                            <!-- Message initial du bot -->
                            <div class="chat-message bot-message">
                                <div class="message-content">
                                    <p>Bonjour ! Je suis votre assistant de sécurité réseau. Comment puis-je vous aider aujourd'hui ?</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <form id="chatForm" class="d-flex">
                        <input type="text" id="userMessage" class="form-control me-2" placeholder="Posez votre question ici..." required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i> Envoyer
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Questions suggérées
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="suggestion-item" onclick="sendSuggestedQuestion('Comment améliorer la sécurité de mon réseau WiFi ?')">
                                <i class="fas fa-wifi me-2 text-primary"></i> Comment améliorer la sécurité de mon réseau WiFi ?
                            </div>
                            <div class="suggestion-item" onclick="sendSuggestedQuestion('Quelle est la différence entre WPA2 et WPA3 ?')">
                                <i class="fas fa-lock me-2 text-primary"></i> Quelle est la différence entre WPA2 et WPA3 ?
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="suggestion-item" onclick="sendSuggestedQuestion('Comment créer un mot de passe WiFi sécurisé ?')">
                                <i class="fas fa-key me-2 text-primary"></i> Comment créer un mot de passe WiFi sécurisé ?
                            </div>
                            <div class="suggestion-item" onclick="sendSuggestedQuestion('Mon réseau est-il vulnérable aux attaques ?')">
                                <i class="fas fa-shield-virus me-2 text-primary"></i> Mon réseau est-il vulnérable aux attaques ?
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Historique des conversations
                    </h5>
                </div>
                <div class="card-body conversation-history" id="conversationHistory">
                    <!-- L'historique des conversations sera chargé ici -->
                    <p class="text-center text-muted" id="noHistoryMessage">Aucune conversation précédente</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .chat-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .chat-message {
        display: flex;
        margin-bottom: 1rem;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .user-message {
        justify-content: flex-end;
    }
    
    .message-content {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
    }
    
    .bot-message .message-content {
        background-color: #f1f1f1;
        border-top-left-radius: 0;
    }
    
    .user-message .message-content {
        background-color: #007bff;
        color: white;
        border-top-right-radius: 0;
    }
    
    .suggestion-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .suggestion-item:hover {
        background-color: #e9ecef;
        transform: translateY(-2px);
    }
    
    .conversation-history {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .chat-avatar {
        width: 60px;
        height: 60px;
        background-color: #f1f1f1;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Loading dots animation */
    .typing-indicator {
        display: flex;
        padding: 0.5rem 1rem;
        background-color: #f1f1f1;
        border-radius: 1rem;
        border-top-left-radius: 0;
        margin-bottom: 1rem;
        width: fit-content;
    }
    
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #888;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .typing-indicator span:nth-child(1) {
        animation: bounce 1s infinite 0.1s;
    }
    
    .typing-indicator span:nth-child(2) {
        animation: bounce 1s infinite 0.3s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation: bounce 1s infinite 0.5s;
        margin-right: 0;
    }
    
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chatForm');
        const userMessageInput = document.getElementById('userMessage');
        const messagesContainer = document.getElementById('messagesContainer');
        const chatContainer = document.getElementById('chatMessages');
        const conversationHistoryContainer = document.getElementById('conversationHistory');
        const noHistoryMessage = document.getElementById('noHistoryMessage');
        
        let conversationId = null;
        
        // Chargement de l'historique des conversations
        loadConversationHistory();
        
        // Gestionnaire de soumission du formulaire
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const userMessage = userMessageInput.value.trim();
            if (userMessage) {
                addUserMessage(userMessage);
                userMessageInput.value = '';
                
                // Afficher l'indicateur de chargement
                showTypingIndicator();
                
                // Envoyer le message au serveur
                sendMessageToBot(userMessage);
            }
        });
        
        // Fonction pour ajouter un message de l'utilisateur
        function addUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', 'user-message');
            messageElement.innerHTML = `
                <div class="message-content">
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            scrollToBottom();
        }
        
        // Fonction pour ajouter un message du bot
        function addBotMessage(message) {
            // Supprimer l'indicateur de chargement
            removeTypingIndicator();
            
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', 'bot-message');
            messageElement.innerHTML = `
                <div class="message-content">
                    <p>${message}</p>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            scrollToBottom();
        }
        
        // Fonction pour afficher l'indicateur de chargement
        function showTypingIndicator() {
            const indicatorElement = document.createElement('div');
            indicatorElement.classList.add('typing-indicator');
            indicatorElement.id = 'typingIndicator';
            indicatorElement.innerHTML = `
                <span></span>
                <span></span>
                <span></span>
            `;
            messagesContainer.appendChild(indicatorElement);
            scrollToBottom();
        }
        
        // Fonction pour supprimer l'indicateur de chargement
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Fonction pour faire défiler vers le bas
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Fonction pour envoyer le message au serveur
        function sendMessageToBot(message) {
            fetch('/api/chatbot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: conversationId
                })
            })
            .then(response => response.json())
            .then(data => {
                addBotMessage(data.response);
                conversationId = data.conversation_id;
                
                // Mettre à jour l'historique des conversations
                if (!conversationId) {
                    loadConversationHistory();
                }
            })
            .catch(error => {
                console.error('Erreur lors de l\'envoi du message:', error);
                addBotMessage('Désolé, une erreur s\'est produite. Veuillez réessayer.');
            });
        }
        
        // Fonction pour échapper les caractères HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Fonction pour charger l'historique des conversations
        function loadConversationHistory() {
            fetch('/api/chatbot/history')
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    noHistoryMessage.style.display = 'none';
                    
                    conversationHistoryContainer.innerHTML = '';
                    data.forEach(conversation => {
                        const conversationElement = document.createElement('div');
                        conversationElement.classList.add('conversation-item', 'mb-2', 'p-2', 'border-bottom');
                        
                        // Convertir le format de date YYYYMMDD en format plus lisible
                        const year = conversation.date.substring(0, 4);
                        const month = conversation.date.substring(4, 6);
                        const day = conversation.date.substring(6, 8);
                        const formattedDate = `${day}/${month}/${year}`;
                        
                        conversationElement.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${formattedDate}</small>
                                <span class="badge bg-primary">${conversation.message_count} messages</span>
                            </div>
                            <p class="mb-1 text-truncate">${escapeHtml(conversation.first_message)}</p>
                            <button class="btn btn-sm btn-outline-primary load-conversation" data-id="${conversation.id}">
                                Reprendre
                            </button>
                        `;
                        conversationHistoryContainer.appendChild(conversationElement);
                    });
                    
                    // Ajouter des écouteurs d'événements aux boutons
                    document.querySelectorAll('.load-conversation').forEach(button => {
                        button.addEventListener('click', function() {
                            loadConversation(this.getAttribute('data-id'));
                        });
                    });
                } else {
                    noHistoryMessage.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement de l\'historique:', error);
            });
        }
        
        // Fonction pour charger une conversation existante
        function loadConversation(id) {
            fetch(`/api/chatbot/conversation/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    conversationId = id;
                    messagesContainer.innerHTML = '';
                    
                    data.forEach(message => {
                        // Ajouter le message de l'utilisateur
                        addUserMessage(message.user_input);
                        
                        // Ajouter la réponse du bot
                        addBotMessage(message.response);
                    });
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement de la conversation:', error);
            });
        }
    });
    
    // Fonction pour envoyer une question suggérée
    function sendSuggestedQuestion(question) {
        document.getElementById('userMessage').value = question;
        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
    }
</script>
{% endblock %}