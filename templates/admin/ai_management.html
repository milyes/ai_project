{% extends "base.html" %}
{% block title %}Gestion des clones IA - Administration{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Menu latéral d'administration -->
        <div class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
            <div class="position-sticky pt-3">
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>Administration</span>
                </h6>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Tableau de bord
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('admin_ai_management') }}">
                            <i class="fas fa-robot me-2"></i>
                            Gestion IA
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_security') }}">
                            <i class="fas fa-shield-alt me-2"></i>
                            Sécurité
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_users') }}">
                            <i class="fas fa-users me-2"></i>
                            Utilisateurs
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_system') }}">
                            <i class="fas fa-server me-2"></i>
                            Système
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Contenu principal -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-robot me-2"></i>Gestion des clones IA
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createCloneModal">
                        <i class="fas fa-plus me-1"></i> Nouveau clone
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshClonesBtn">
                        <i class="fas fa-sync me-1"></i> Actualiser
                    </button>
                </div>
            </div>

            <!-- Statistiques générales des clones -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">Total des clones</h6>
                                    <h2 class="mb-0" id="totalClones">{{ statistics.total_clones }}</h2>
                                </div>
                                <div>
                                    <i class="fas fa-clone fa-3x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">Clones actifs</h6>
                                    <h2 class="mb-0" id="activeClones">{{ statistics.status.active }}</h2>
                                </div>
                                <div>
                                    <i class="fas fa-play-circle fa-3x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">En entraînement</h6>
                                    <h2 class="mb-0" id="trainingClones">{{ statistics.status.training }}</h2>
                                </div>
                                <div>
                                    <i class="fas fa-brain fa-3x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">Requêtes traitées</h6>
                                    <h2 class="mb-0" id="totalRequests">{{ statistics.total_requests_processed }}</h2>
                                </div>
                                <div>
                                    <i class="fas fa-tachometer-alt fa-3x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tableau des clones -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Clones IA</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Spécialisation</th>
                                    <th>Version</th>
                                    <th>Statut</th>
                                    <th>Confiance</th>
                                    <th>Performances</th>
                                    <th>Dernière activité</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clonesTableBody">
                                {% for clone in clones %}
                                <tr>
                                    <td>{{ clone.name }}</td>
                                    <td>
                                        {% if clone.specialization == "network" %}
                                        <span class="badge bg-primary">Réseau</span>
                                        {% elif clone.specialization == "protocol" %}
                                        <span class="badge bg-info">Protocole</span>
                                        {% elif clone.specialization == "vulnerability" %}
                                        <span class="badge bg-danger">Vulnérabilité</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Général</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ clone.version }}</td>
                                    <td>
                                        {% if clone.status == "active" %}
                                        <span class="badge bg-success">Actif</span>
                                        {% elif clone.status == "paused" %}
                                        <span class="badge bg-warning">En pause</span>
                                        {% elif clone.status == "training" %}
                                        <span class="badge bg-info">En entraînement</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Arrêté</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ (clone.confidence_threshold * 100)|int }}%</td>
                                    <td>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar" style="width: {{ clone.performance_metrics.accuracy * 100 }}%;" aria-valuenow="{{ clone.performance_metrics.accuracy * 100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <small class="text-muted">{{ clone.performance_metrics.requests_processed }} req. ({{ clone.performance_metrics.average_response_time|round(3) }} s)</small>
                                    </td>
                                    <td>{{ clone.last_activity|datetime }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary view-clone" data-clone-id="{{ clone.clone_id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if clone.status == "active" %}
                                            <button class="btn btn-sm btn-outline-warning pause-clone" data-clone-id="{{ clone.clone_id }}">
                                                <i class="fas fa-pause"></i>
                                            </button>
                                            {% elif clone.status == "paused" %}
                                            <button class="btn btn-sm btn-outline-success resume-clone" data-clone-id="{{ clone.clone_id }}">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-info train-clone" data-clone-id="{{ clone.clone_id }}">
                                                <i class="fas fa-brain"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-clone" data-clone-id="{{ clone.clone_id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Graphique de distribution des spécialisations -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Distribution des spécialisations</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="specializationChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Activité des clones</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="activityChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal de création de clone -->
<div class="modal fade" id="createCloneModal" tabindex="-1" role="dialog" aria-labelledby="createCloneModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createCloneModalLabel">Créer un nouveau clone IA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createCloneForm">
                    <div class="mb-3">
                        <label for="cloneName" class="form-label">Nom du clone</label>
                        <input type="text" class="form-control" id="cloneName" required placeholder="Clone IA Réseau">
                    </div>
                    <div class="mb-3">
                        <label for="cloneSpecialization" class="form-label">Spécialisation</label>
                        <select class="form-select" id="cloneSpecialization" required>
                            <option value="general">Général</option>
                            <option value="network">Réseau</option>
                            <option value="protocol">Protocole</option>
                            <option value="vulnerability">Vulnérabilité</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="learningRate" class="form-label">Taux d'apprentissage: <span id="learningRateValue">0.5</span></label>
                        <input type="range" class="form-range" min="0.01" max="1" step="0.01" value="0.5" id="learningRate">
                        <small class="form-text text-muted">Un taux plus élevé permet un apprentissage plus rapide mais potentiellement moins stable.</small>
                    </div>
                    <div class="mb-3">
                        <label for="confidenceThreshold" class="form-label">Seuil de confiance: <span id="confidenceThresholdValue">70%</span></label>
                        <input type="range" class="form-range" min="0" max="1" step="0.01" value="0.7" id="confidenceThreshold">
                        <small class="form-text text-muted">Un seuil plus élevé exige plus de certitude pour les prédictions mais peut réduire le nombre de réponses.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="createCloneBtn">Créer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de détails du clone -->
<div class="modal fade" id="cloneDetailsModal" tabindex="-1" role="dialog" aria-labelledby="cloneDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cloneDetailsModalLabel">Détails du clone IA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="cloneDetails">
                    <!-- Les détails du clone seront chargés ici via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'entraînement du clone -->
<div class="modal fade" id="trainCloneModal" tabindex="-1" role="dialog" aria-labelledby="trainCloneModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trainCloneModalLabel">Entraîner le clone IA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="trainCloneForm">
                    <input type="hidden" id="trainCloneId">
                    <div class="mb-3">
                        <label for="trainingDatasets" class="form-label">Jeux de données d'entraînement</label>
                        <select class="form-select" id="trainingDatasets" multiple size="4" required>
                            <option value="network_security">Sécurité réseau</option>
                            <option value="protocol_vulnerabilities">Vulnérabilités de protocole</option>
                            <option value="device_security">Sécurité des appareils</option>
                            <option value="wifi_threats">Menaces WiFi</option>
                            <option value="trend_analysis">Analyse de tendances</option>
                        </select>
                        <small class="form-text text-muted">Maintenez Ctrl pour sélectionner plusieurs jeux de données.</small>
                    </div>
                    <div class="mb-3">
                        <label for="trainingEpochs" class="form-label">Nombre d'époques: <span id="trainingEpochsValue">10</span></label>
                        <input type="range" class="form-range" min="1" max="50" value="10" id="trainingEpochs">
                        <small class="form-text text-muted">Plus le nombre d'époques est élevé, plus l'entraînement sera approfondi mais long.</small>
                    </div>
                    <div class="mb-3">
                        <label for="trainingBatchSize" class="form-label">Taille des lots: <span id="trainingBatchSizeValue">32</span></label>
                        <input type="range" class="form-range" min="8" max="128" step="8" value="32" id="trainingBatchSize">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="preservePrevious" checked>
                        <label class="form-check-label" for="preservePrevious">
                            Préserver les connaissances précédentes
                        </label>
                        <small class="form-text text-muted d-block">Désactiver cette option peut entraîner un "oubli catastrophique" des connaissances précédentes.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="startTrainingBtn">Lancer l'entraînement</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation des graphiques
    initializeCharts();
    
    // Configuration des sliders
    document.getElementById('learningRate').addEventListener('input', function() {
        document.getElementById('learningRateValue').textContent = this.value;
    });
    
    document.getElementById('confidenceThreshold').addEventListener('input', function() {
        document.getElementById('confidenceThresholdValue').textContent = (this.value * 100) + '%';
    });
    
    document.getElementById('trainingEpochs').addEventListener('input', function() {
        document.getElementById('trainingEpochsValue').textContent = this.value;
    });
    
    document.getElementById('trainingBatchSize').addEventListener('input', function() {
        document.getElementById('trainingBatchSizeValue').textContent = this.value;
    });
    
    // Gestionnaire pour le bouton de création de clone
    document.getElementById('createCloneBtn').addEventListener('click', function() {
        const name = document.getElementById('cloneName').value;
        const specialization = document.getElementById('cloneSpecialization').value;
        const learningRate = parseFloat(document.getElementById('learningRate').value);
        const confidenceThreshold = parseFloat(document.getElementById('confidenceThreshold').value);
        
        if (!name) {
            alert('Veuillez saisir un nom pour le clone');
            return;
        }
        
        // Appel AJAX pour créer le clone
        fetch('/api/admin/clones', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                specialization: specialization,
                learning_rate: learningRate,
                confidence_threshold: confidenceThreshold
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fermer le modal et rafraîchir la page
                $('#createCloneModal').modal('hide');
                window.location.reload();
            } else {
                alert('Erreur lors de la création du clone: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la création du clone');
        });
    });
    
    // Gestionnaire pour le bouton de rafraîchissement
    document.getElementById('refreshClonesBtn').addEventListener('click', function() {
        window.location.reload();
    });
    
    // Gestionnaires pour les actions sur les clones
    document.querySelectorAll('.view-clone').forEach(button => {
        button.addEventListener('click', function() {
            const cloneId = this.getAttribute('data-clone-id');
            viewCloneDetails(cloneId);
        });
    });
    
    document.querySelectorAll('.pause-clone').forEach(button => {
        button.addEventListener('click', function() {
            const cloneId = this.getAttribute('data-clone-id');
            updateCloneStatus(cloneId, 'paused');
        });
    });
    
    document.querySelectorAll('.resume-clone').forEach(button => {
        button.addEventListener('click', function() {
            const cloneId = this.getAttribute('data-clone-id');
            updateCloneStatus(cloneId, 'active');
        });
    });
    
    document.querySelectorAll('.train-clone').forEach(button => {
        button.addEventListener('click', function() {
            const cloneId = this.getAttribute('data-clone-id');
            document.getElementById('trainCloneId').value = cloneId;
            $('#trainCloneModal').modal('show');
        });
    });
    
    document.querySelectorAll('.delete-clone').forEach(button => {
        button.addEventListener('click', function() {
            const cloneId = this.getAttribute('data-clone-id');
            if (confirm('Êtes-vous sûr de vouloir supprimer ce clone IA ?')) {
                deleteClone(cloneId);
            }
        });
    });
    
    // Gestionnaire pour le bouton de lancement d'entraînement
    document.getElementById('startTrainingBtn').addEventListener('click', function() {
        const cloneId = document.getElementById('trainCloneId').value;
        const datasetsSelect = document.getElementById('trainingDatasets');
        const selectedDatasets = Array.from(datasetsSelect.selectedOptions).map(option => option.value);
        const epochs = parseInt(document.getElementById('trainingEpochs').value);
        const batchSize = parseInt(document.getElementById('trainingBatchSize').value);
        const preservePrevious = document.getElementById('preservePrevious').checked;
        
        if (selectedDatasets.length === 0) {
            alert('Veuillez sélectionner au moins un jeu de données');
            return;
        }
        
        // Appel AJAX pour démarrer l'entraînement
        fetch(`/api/admin/clones/${cloneId}/train`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                datasets: selectedDatasets,
                epochs: epochs,
                batch_size: batchSize,
                preserve_previous: preservePrevious
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#trainCloneModal').modal('hide');
                alert('Entraînement démarré avec succès');
                window.location.reload();
            } else {
                alert('Erreur lors du démarrage de l\'entraînement: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors du démarrage de l\'entraînement');
        });
    });
});

/**
 * Initialise les graphiques sur la page
 */
function initializeCharts() {
    // Données du graphique de spécialisation
    const specializationData = {
        labels: ['Général', 'Réseau', 'Protocole', 'Vulnérabilité'],
        datasets: [{
            data: [
                {{ statistics.specializations.get('general', 0) }},
                {{ statistics.specializations.get('network', 0) }},
                {{ statistics.specializations.get('protocol', 0) }},
                {{ statistics.specializations.get('vulnerability', 0) }}
            ],
            backgroundColor: ['#6c757d', '#0d6efd', '#0dcaf0', '#dc3545'],
            borderWidth: 0
        }]
    };
    
    // Configuration du graphique de spécialisation
    const specializationConfig = {
        type: 'doughnut',
        data: specializationData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    };
    
    // Créer le graphique de spécialisation
    new Chart(
        document.getElementById('specializationChart'),
        specializationConfig
    );
    
    // Données du graphique d'activité (simulées)
    const activityData = {
        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
        datasets: [{
            label: 'Requêtes traitées',
            data: [65, 59, 80, 81, 56, 55, 40],
            fill: false,
            borderColor: '#0d6efd',
            tension: 0.1
        }]
    };
    
    // Configuration du graphique d'activité
    const activityConfig = {
        type: 'line',
        data: activityData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    };
    
    // Créer le graphique d'activité
    new Chart(
        document.getElementById('activityChart'),
        activityConfig
    );
}

/**
 * Affiche les détails d'un clone IA
 */
function viewCloneDetails(cloneId) {
    // Appel AJAX pour récupérer les détails du clone
    fetch(`/api/admin/clones/${cloneId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const clone = data.clone;
                const trainingHistory = clone.training_sessions || [];
                
                // Construire l'HTML des détails
                let detailsHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <h4>${clone.name}</h4>
                            <p class="text-muted">ID: ${clone.clone_id}</p>
                            
                            <div class="mb-3">
                                <h6>Informations générales</h6>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Spécialisation
                                        <span class="badge bg-primary">${clone.specialization}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Version
                                        <span>${clone.version}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Statut
                                        <span class="badge bg-${getStatusClass(clone.status)}">${clone.status}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Taux d'apprentissage
                                        <span>${clone.learning_rate}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Seuil de confiance
                                        <span>${(clone.confidence_threshold * 100).toFixed(0)}%</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Métriques de performance</h6>
                            <ul class="list-group mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Requêtes traitées
                                    <span>${clone.performance_metrics.requests_processed}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Temps de réponse moyen
                                    <span>${clone.performance_metrics.average_response_time.toFixed(3)} s</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Précision
                                    <span>${(clone.performance_metrics.precision * 100).toFixed(1)}%</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Rappel
                                    <span>${(clone.performance_metrics.recall * 100).toFixed(1)}%</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Score F1
                                    <span>${(clone.performance_metrics.f1_score * 100).toFixed(1)}%</span>
                                </li>
                            </ul>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="editClone('${clone.clone_id}')">
                                    <i class="fas fa-edit me-1"></i> Modifier les paramètres
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>Historique des entraînements</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Statut</th>
                                    <th>Jeux de données</th>
                                    <th>Époques</th>
                                    <th>Temps</th>
                                    <th>Amélioration</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${trainingHistory.length > 0 ? 
                                    trainingHistory.map(session => `
                                        <tr>
                                            <td>${formatDate(session.start_time)}</td>
                                            <td>
                                                <span class="badge bg-${session.status === 'completed' ? 'success' : 'info'}">
                                                    ${session.status}
                                                </span>
                                            </td>
                                            <td>${session.params.datasets ? session.params.datasets.join(', ') : '-'}</td>
                                            <td>${session.params.epochs || '-'}</td>
                                            <td>${session.end_time ? calculateDuration(session.start_time, session.end_time) : 'En cours'}</td>
                                            <td>${session.results.improvement || '-'}</td>
                                        </tr>
                                    `).join('') : 
                                    '<tr><td colspan="6" class="text-center">Aucun entraînement enregistré</td></tr>'
                                }
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Afficher les détails dans le modal
                document.getElementById('cloneDetails').innerHTML = detailsHtml;
                $('#cloneDetailsModal').modal('show');
            } else {
                alert('Erreur lors de la récupération des détails du clone: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la récupération des détails du clone');
        });
}

/**
 * Met à jour le statut d'un clone IA
 */
function updateCloneStatus(cloneId, status) {
    // Appel AJAX pour mettre à jour le statut
    fetch(`/api/admin/clones/${cloneId}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: status
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Erreur lors de la mise à jour du statut: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de la mise à jour du statut');
    });
}

/**
 * Supprime un clone IA
 */
function deleteClone(cloneId) {
    // Appel AJAX pour supprimer le clone
    fetch(`/api/admin/clones/${cloneId}`, {
        method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Erreur lors de la suppression du clone: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de la suppression du clone');
    });
}

/**
 * Ouvre le formulaire d'édition d'un clone
 */
function editClone(cloneId) {
    // À implémenter si nécessaire
    alert('Fonctionnalité d\'édition non implémentée');
}

/**
 * Retourne la classe CSS pour un statut donné
 */
function getStatusClass(status) {
    switch (status) {
        case 'active': return 'success';
        case 'paused': return 'warning';
        case 'training': return 'info';
        default: return 'secondary';
    }
}

/**
 * Formate une date en format lisible
 */
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

/**
 * Calcule la durée entre deux dates ISO
 */
function calculateDuration(startDateStr, endDateStr) {
    const start = new Date(startDateStr);
    const end = new Date(endDateStr);
    const durationMs = end - start;
    
    // Convertir en minutes et secondes
    const minutes = Math.floor(durationMs / 60000);
    const seconds = Math.floor((durationMs % 60000) / 1000);
    
    return `${minutes}m ${seconds}s`;
}
</script>
{% endblock %}